<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fight Club Ending Spoiler</title>
    <style>
      body {
        color: white;
        margin: 0;
        padding: 0;
        background-color: black;
      }
      
      #thing{
        text-align: center;
      }

      h1 {
        position: absolute;
        top: 0;
        width: 100%;
      }

      video {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="thing">
      <h1>what's that song at the end of fight club again?</h1>
    </div>

    <audio id="allstar" src="allstar.mp3"></audio>
    <video id="fightclub" src="ending.mp4" autoplay controls></video>

    <script>
      var allStarStart = 10.729783
      var speak1Start = 22.833128
      var speak1End = 25.717966
      fightclub.addEventListener("seeked", handleSeek)
      fightclub.addEventListener("play", handleSeek)
      fightclub.addEventListener("pause", handleSeek)
      
      function shouldFightClubPlay(t) {
        isSpeaking = t > speak1Start && t < speak1End
        return (t < allStarStart || isSpeaking)
      }
        
      function shouldAllStarPlay(t) {
        return t > allStarStart
      }
      
      function handleSeek() {
        t = fightclub.currentTime
        if (shouldFightClubPlay(t)) {
          fightVolumeOn();
        } else {
          fightVolumeOff();
        }
        
        if (t < allStarStart) {
          allstar.currentTime = 0
          allstar.pause()
          setTimers(t)
        } else {
          allstar.currentTime = t - allStarStart
          allstar.volume = .8
          if (fightclub.paused) {
            allstar.pause()
          } else {
            allstar.play()
          }
        }
      }
      
      var playAllStarTimer, speakStartTimer, speakEndTimer;
      function setTimers(t=0) {
        clearTimeout(playAllStarTimer)
        clearTimeout(speakStartTimer)
        clearTimeout(speakEndTimer)
        playAllStarTimer = setTimeout(()=> allstar.play(), (allStarStart - t) * 1000);
        speakStartTimer = setTimeout(()=>{fightVolumeOn(); allstar.volume = .5}, (allStarStart - t) * 1000);
        speakEndTimer = setTimeout(()=>{fightVolumeOff(); allstar.volume = .8}, (allStarStart - t) * 1000);
      }
      
      function fightVolumeOn() {
        console.log("fight on")
        fightclub.volume = 1
      }
      
      function fightVolumeOff() {
        console.log("fight off")
        fightclub.volume = 0
      }
    </script>
  </body>
</html>
